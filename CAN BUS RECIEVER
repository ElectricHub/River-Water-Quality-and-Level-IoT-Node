#include <Wire.h>
#include <SPI.h>
#include <mcp2515.h>

MCP2515 mcp2515(10);
struct can_frame canMsg;
float level = 0;
char data[6];
float levelCM = 0;
void setup() {
  Serial.begin(9600);
  SPI.begin();
  mcp2515.reset();
  mcp2515.setBitrate(CAN_500KBPS, MCP_8MHZ);
  mcp2515.setNormalMode();
  Serial.println("Ready");

  Wire.begin(9);
  Wire.onRequest(_sendData);
}

void loop()
{
  if (mcp2515.readMessage(&canMsg) == MCP2515::ERROR_OK)
  {
    if (canMsg.data[0] == canMsg.data[2] && canMsg.data[1] == canMsg.data[3])
    {
      String concatValve  = String(canMsg.data[0]) + String(canMsg.data[1]) ;//sendval
      int  level1 = concatValve.toInt();
      levelCM = level1 / 10.0;

      Serial.print("Waterlevel in cm = ");
      Serial.println(levelCM);
    }
  }

  level = levelCM;
  delay(1000);
}

void _sendData()
{

  dtostrf(level, 6, 2, data);

  Wire.write(data); // appx 8 bytes
  Wire.write(",");
  Wire.write("\n");
  Serial.println("I2C data send");

}
